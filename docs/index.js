function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function _toISBN10(d){d+="";let a=[];a=d.substr(3,9).split("");let e=0,b,c;for(let b=0;b<9;b++)e+=a[b]*(10-b);return b=11-e%11,b==10?c="x":b==11?c=0:c=b,a.push(c),a.join("")}function toISBN13(g,h){const e=10,f=3;let d=h.trim().toUpperCase().replace(/[^\dX]/gi,"");d=g+d;let c=0;const a=d.split("");for(let b=0;b<a.length-1;b++)b%2==0?c+=parseInt(a[b]):c+=f*parseInt(a[b]);c=e-c%e;let b="";for(let c=0;c<a.length-1;c++)b=b+a[c];return b=b+c,b}function isValidISBN13(e){const c=10,f=3,d=e.trim().toUpperCase().replace(/[^\d]/gi,"");if(d.length!=13)return!1;let a=0;const b=d.split("");for(let c=0;c<b.length-1;c++)c%2==0?a+=parseInt(b[c]):a+=f*parseInt(b[c]);return a=c-a%c,a==parseInt(b[b.length-1])}function isValidISBN10(g){const d=11;let e=10;const f=g.trim().toUpperCase().replace(/[^\dX]/gi,"");if(f.length!=10)return!1;let b=0;const a=f.split("");for(let c=0;c<a.length-1;c++)b+=e*parseInt(a[c]),e--;b=d-b%d;let c=10;return a[a.length-1]!="X"&&(c=parseInt(a[a.length-1])),b==c}function _isISBN13(a){return!!(a.startsWith("978")||a.startsWith("979"))}function isValidEAN(a){a=("00000"+a).slice(-13);let b=0,c=0;for(let d=0;d<a.length-1;d++)d%2==0?c+=parseInt(a[d]):b+=parseInt(a[d]);return 10-parseInt((b*3+c).toString().slice(-1))===parseInt(a.slice(-1))}function getInfoFromISBN(b,a){fetch("https://app.rakuten.co.jp/services/api/Product/Search/20170426?format=json&affiliateId=1fce7ad4.9ceb2f6a.1fce7ad5.f0e8d979&applicationId=1017197774015471253&keyword="+b).then(a=>a.json()).then(b=>{if(b.hits>0){const d=b.Products[0].Product,e=d.productName,f=d.affiliateUrl,c=document.createElement("a");c.href=f,c.textContent=e,a&&a(c)}})}function _getInfoFromISBNByGoogle(b,a){fetch("https://www.googleapis.com/books/v1/volumes?q="+b).then(a=>a.json()).then(b=>{if(b.totalItems>0){const c=b.items[0].volumeInfo.title,d=document.createTextNode(c);a&&a(d)}})}function initScan(){const b=new ZXing.BrowserMultiFormatReader,a=document.getElementById("memo");b.getVideoInputDevices().then(c=>{const d=c[0].deviceId;b.decodeFromVideoDevice(d,"video",(b,c)=>{!waiting&&b&&(a.children.length==0||a.children[1].children[0].textContent!=b.text)&&setProductInfo(b,a)})}).catch(a=>{console.error(a)})}function setProductInfo(a,d){const b=document.createElement("scanned-box"),c=b.shadowRoot.querySelector(".product");b.shadowRoot.querySelector(".code").textContent=a.text,isValidISBN13(a.text)?getInfoFromISBN(a.text,a=>{c.appendChild(a)}):isValidISBN10(a.text)?["978","979"].some(b=>{const d=toISBN13(b,a.text);if(isValidISBN13(d))return getInfoFromISBN(a.text,a=>{c.appendChild(productInfo)}),!0}):isValidEAN(a.text)&&getInfoFromISBN(a.text,a=>{c.appendChild(a)}),d.appendChild(b.shadowRoot),waiting=!0,setTimeout(()=>{waiting=!1},1e3)}function toCSV(){let a="";const b=[...document.getElementById("memo").getElementsByTagName("tr")];b.forEach(b=>{const c=[...b.children].slice(0,2),d=c.map(a=>a.textContent).join(", ");a+=d+"\n"}),copyToClipboard(a)}async function copyToClipboard(a){await navigator.clipboard.writeText(a),alert("クリップボードにコピーしました。")}customElements.define("scanned-box",class extends HTMLElement{constructor(){super();const a=document.getElementById("scanned-box").content.cloneNode(!0);a.querySelector("button").onclick=function(){this.parentNode.parentNode.remove()},this.attachShadow({mode:"open"}).appendChild(a)}});let waiting=!1;loadConfig(),initScan(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toCSV").onclick=toCSV