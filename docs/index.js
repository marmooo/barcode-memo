function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toISBN13(e,t){const a=10,r=3;let i=t.trim().toUpperCase().replace(/[^\dX]/gi,"");i=e+i;let n=0;const s=i.split("");for(let e=0;e<s.length-1;e++)e%2==0?n+=parseInt(s[e]):n+=r*parseInt(s[e]);n=a-n%a;let o="";for(let e=0;e<s.length-1;e++)o=o+s[e];return o=o+n,o}function isValidISBN13(e){const s=10,i=3,o=e.trim().toUpperCase().replace(/[^\d]/gi,"");if(o.length!=13)return!1;let t=0;const n=o.split("");for(let e=0;e<n.length-1;e++)e%2==0?t+=parseInt(n[e]):t+=i*parseInt(n[e]);return t=s-t%s,t==parseInt(n[n.length-1])}function isValidISBN10(e){const s=11;let o=10;const i=e.trim().toUpperCase().replace(/[^\dX]/gi,"");if(i.length!=10)return!1;let n=0;const t=i.split("");for(let e=0;e<t.length-1;e++)n+=o*parseInt(t[e]),o--;n=s-n%s;let a=10;return t[t.length-1]!="X"&&(a=parseInt(t[t.length-1])),n==a}function isValidEAN(e){e=("00000"+e).slice(-13);let t=0,n=0;for(let s=0;s<e.length-1;s++)s%2==0?n+=parseInt(e[s]):t+=parseInt(e[s]);return 10-parseInt((t*3+n).toString().slice(-1))===parseInt(e.slice(-1))}function getInfoFromISBN(e,t){fetch("https://app.rakuten.co.jp/services/api/Product/Search/20170426?format=json&affiliateId=1fce7ad4.9ceb2f6a.1fce7ad5.f0e8d979&applicationId=1017197774015471253&keyword="+e).then(e=>e.json()).then(e=>{if(e.hits>0){const s=e.Products[0].Product,o=s.productName,i=s.affiliateUrl,n=document.createElement("a");n.href=i,n.textContent=o,t&&t(n)}})}function tick(e){if(video.readyState===video.HAVE_ENOUGH_DATA){{loadingMessage.hidden=!0;const t=video.videoWidth,n=video.videoHeight;if(canvasElement.width=t,canvasElement.height=n,canvas.drawImage(video,0,0,t,n),e-prevTime>500){prevTime=e;const s=canvas.getImageData(0,0,t,n);worker.postMessage({data:s.data,width:t,height:n})}}}else loadingMessage.textContent="⌛ Loading video...";requestAnimationFrame(tick)}function initScan(){navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(e=>{video.srcObject=e,video.setAttribute("playsinline","true"),video.play(),requestAnimationFrame(tick)}).catch(e=>{alert(e.message)})}function setProductInfo(e){const t=document.createElement("scanned-box"),n=t.shadowRoot.querySelector(".product");t.shadowRoot.querySelector(".code").textContent=e,isValidISBN13(e)?getInfoFromISBN(e,e=>{n.appendChild(e)}):isValidISBN10(e)?["978","979"].some(t=>{const s=toISBN13(t,e);if(isValidISBN13(s))return getInfoFromISBN(e,e=>{n.appendChild(e)}),!0}):isValidEAN(e)&&getInfoFromISBN(e,e=>{n.appendChild(e)}),document.getElementById("memo").appendChild(t.shadowRoot)}function toCSV(){let e="";const t=[...document.getElementById("memo").getElementsByTagName("tr")];t.forEach(t=>{const n=[...t.children].slice(0,2),s=n.map(e=>e.textContent).join(", ");e+=s+`
`}),copyToClipboard(e)}async function copyToClipboard(e){await navigator.clipboard.writeText(e),alert("クリップボードにコピーしました。")}function initWorker(){const e=new Worker("/barcode-memo/koder.js");return e.onmessage=e=>{const t=e.data.data;if(!t)return;prevCode!=t&&(prevCode=t,setProductInfo(t))},e}customElements.define("scanned-box",class extends HTMLElement{constructor(){super();const e=document.getElementById("scanned-box").content.cloneNode(!0);e.querySelector("button").onclick=e=>{e.target.parentNode.parentNode.remove()},this.attachShadow({mode:"open"}).appendChild(e)}});let prevTime=0,prevCode;loadConfig();const video=document.createElement("video"),canvasElement=document.getElementById("canvas"),canvas=canvasElement.getContext("2d"),loadingMessage=document.getElementById("loadingMessage"),worker=initWorker();initScan(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toCSV").onclick=toCSV