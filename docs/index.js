function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function _toISBN10(a){const b=a.split("").slice(3,12).reduce((a,b,c)=>a+(b[0]-"0")*(10-c),0),c=11-b%11,d=a.substring(3,12)+c.toString();return d}function toISBN13(g,h){const e=10,f=3;let d=h.trim().toUpperCase().replace(/[^\dX]/gi,"");d=g+d;let c=0;const a=d.split("");for(let b=0;b<a.length-1;b++)b%2==0?c+=parseInt(a[b]):c+=f*parseInt(a[b]);c=e-c%e;let b="";for(let c=0;c<a.length-1;c++)b=b+a[c];return b=b+c,b}function isValidISBN13(e){const c=10,f=3,d=e.trim().toUpperCase().replace(/[^\d]/gi,"");if(d.length!=13)return!1;let a=0;const b=d.split("");for(let c=0;c<b.length-1;c++)c%2==0?a+=parseInt(b[c]):a+=f*parseInt(b[c]);return a=c-a%c,a==parseInt(b[b.length-1])}function isValidISBN10(g){const d=11;let e=10;const f=g.trim().toUpperCase().replace(/[^\dX]/gi,"");if(f.length!=10)return!1;let b=0;const a=f.split("");for(let c=0;c<a.length-1;c++)b+=e*parseInt(a[c]),e--;b=d-b%d;let c=10;return a[a.length-1]!="X"&&(c=parseInt(a[a.length-1])),b==c}function _isISBN13(a){return!!(a.startsWith("978")||a.startsWith("979"))}function isValidEAN(a){a=("00000"+a).slice(-13);let b=0,c=0;for(let d=0;d<a.length-1;d++)d%2==0?c+=parseInt(a[d]):b+=parseInt(a[d]);return 10-parseInt((b*3+c).toString().slice(-1))===parseInt(a.slice(-1))}function getInfoFromISBN(b,a){fetch("https://app.rakuten.co.jp/services/api/Product/Search/20170426?format=json&affiliateId=1fce7ad4.9ceb2f6a.1fce7ad5.f0e8d979&applicationId=1017197774015471253&keyword="+b).then(a=>a.json()).then(b=>{if(b.hits>0){const d=b.Products[0].Product,e=d.productName,f=d.affiliateUrl,c=document.createElement("a");c.href=f,c.textContent=e,a&&a(c)}})}function _getInfoFromISBNByGoogle(b,a){fetch("https://www.googleapis.com/books/v1/volumes?q="+b).then(a=>a.json()).then(b=>{if(b.totalItems>0){const c=b.items[0].volumeInfo.title,d=document.createTextNode(c);a&&a(d)}})}function tick(a){if(video.readyState===video.HAVE_ENOUGH_DATA){{loadingMessage.hidden=!0;const b=video.videoWidth,c=video.videoHeight;if(canvasElement.width=b,canvasElement.height=c,canvas.drawImage(video,0,0,b,c),a-prevTime>500){prevTime=a;const d=canvas.getImageData(0,0,b,c);worker.postMessage({data:d.data,width:b,height:c})}}}else loadingMessage.textContent="⌛ Loading video...";requestAnimationFrame(tick)}function initScan(){navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(a=>{video.srcObject=a,video.setAttribute("playsinline","true"),video.play(),requestAnimationFrame(tick)}).catch(a=>{alert(a.message)})}function setProductInfo(a){const b=document.createElement("scanned-box"),c=b.shadowRoot.querySelector(".product");b.shadowRoot.querySelector(".code").textContent=a,isValidISBN13(a)?getInfoFromISBN(a,a=>{c.appendChild(a)}):isValidISBN10(a)?["978","979"].some(b=>{const d=toISBN13(b,a);if(isValidISBN13(d))return getInfoFromISBN(a,a=>{c.appendChild(a)}),!0}):isValidEAN(a)&&getInfoFromISBN(a,a=>{c.appendChild(a)}),document.getElementById("memo").appendChild(b.shadowRoot)}function toCSV(){let a="";const b=[...document.getElementById("memo").getElementsByTagName("tr")];b.forEach(b=>{const c=[...b.children].slice(0,2),d=c.map(a=>a.textContent).join(", ");a+=d+"\n"}),copyToClipboard(a)}async function copyToClipboard(a){await navigator.clipboard.writeText(a),alert("クリップボードにコピーしました。")}function initWorker(){const a=new Worker("/barcode-memo/koder.js");return a.onmessage=b=>{const a=b.data.data;if(!a)return;prevCode!=a&&(prevCode=a,setProductInfo(a))},a}customElements.define("scanned-box",class extends HTMLElement{constructor(){super();const a=document.getElementById("scanned-box").content.cloneNode(!0);a.querySelector("button").onclick=a=>{a.target.parentNode.parentNode.remove()},this.attachShadow({mode:"open"}).appendChild(a)}});let prevTime=0,prevCode;loadConfig();const video=document.createElement("video"),canvasElement=document.getElementById("canvas"),canvas=canvasElement.getContext("2d"),loadingMessage=document.getElementById("loadingMessage"),worker=initWorker();initScan(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toCSV").onclick=toCSV